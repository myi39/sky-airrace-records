<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sky Air Race è¨˜éŒ²ã¾ã¨ã‚</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #cee6f1 0%, #b8e0d4 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
      }

      header {
        text-align: center;
        color: white;
        margin-bottom: 30px;
      }

      h1 {
        font-size: 3em;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 10px;
      }

      .controls {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }

      .control-group {
        margin-bottom: 20px;
      }

      .control-group:last-child {
        margin-bottom: 0;
      }

      label {
        display: block;
        font-weight: 600;
        margin-bottom: 8px;
        color: #333;
      }

      select {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 16px;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
      }

      select:hover {
        border-color: #667eea;
      }

      select:focus {
        outline: none;
        border-color: #667eea;
      }

      .version-chips {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-top: 10px;
      }

      .version-chip {
        padding: 10px 20px;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        user-select: none;
      }

      .version-chip:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      }

      .version-chip.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 8px;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .checkbox-item:hover {
        background-color: #f5f5f5;
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
      }

      .checkbox-item label {
        margin: 0;
        cursor: pointer;
        font-weight: 500;
      }

      /* ãƒ¬ã‚³ãƒ¼ãƒ‰æ•°ãƒãƒƒã‚¸ */
      .record-count {
        display: inline-block;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-size: 0.75em;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 12px;
        margin-left: 6px;
        min-width: 20px;
        text-align: center;
      }

      .version-chip .record-count {
        background: rgba(255, 255, 255, 0.3);
        color: #333;
        margin-left: 8px;
      }

      .version-chip.selected .record-count {
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
      }

      .ranking-table {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-x: auto;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #666;
      }

      .empty-state-icon {
        font-size: 4em;
        margin-bottom: 20px;
      }

      .empty-state h2 {
        font-size: 1.8em;
        margin-bottom: 10px;
        color: #333;
      }

      .empty-state p {
        font-size: 1.1em;
      }

      table {
        width: 100%;
        border-collapse: collapse;
      }

      thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        cursor: pointer;
        user-select: none;
        position: relative;
      }

      th:hover {
        background: rgba(255, 255, 255, 0.1);
      }

      th.sortable {
        position: relative;
        padding-right: 25px;
      }

      th.sortable::after {
        content: "â–²\Aâ–¼";
        white-space: pre;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        opacity: 0.3;
        font-size: 0.6em;
        line-height: 0.8;
      }

      th.sort-asc::after {
        content: "â–²";
        white-space: pre;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.6em;
        line-height: 0.8;
        background: linear-gradient(
          to bottom,
          currentColor 50%,
          transparent 50%
        );
        -webkit-background-clip: text;
        background-clip: text;
        opacity: 1;
      }

      th.sort-desc::after {
        content: "â–¼";
        white-space: pre;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        font-size: 0.6em;
        line-height: 0.8;
        background: linear-gradient(
          to bottom,
          transparent 50%,
          currentColor 50%
        );
        -webkit-background-clip: text;
        background-clip: text;
        opacity: 1;
      }

      tbody tr {
        border-bottom: 1px solid #e0e0e0;
        transition: background-color 0.2s;
      }

      tbody tr:hover {
        background-color: #f5f5f5;
      }

      tbody tr:last-child {
        border-bottom: none;
      }

      td {
        padding: 15px;
      }

      .rank {
        font-weight: 700;
        font-size: 1.2em;
        color: #667eea;
      }

      .rank-1 {
        color: #ffd700;
      }
      .rank-2 {
        color: #c0c0c0;
      }
      .rank-3 {
        color: #cd7f32;
      }

      .video-link {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 32px;
        height: 32px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        text-decoration: none;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
      }

      .video-link:hover {
        transform: scale(1.1);
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
      }

      .player-link {
        color: #667eea;
        text-decoration: none;
        font-weight: 500;
        transition: color 0.2s;
      }

      .player-link:hover {
        color: #764ba2;
        text-decoration: underline;
      }

      .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.85em;
        font-weight: 600;
      }

      .status-approved {
        background: #d4edda;
        color: #155724;
      }

      .status-pending {
        background: #fff3cd;
        color: #856404;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #666;
        font-size: 1.2em;
      }

      .description {
        text-align: center;
        color: rgba(37, 89, 139, 0.7);
        font-size: 0.9em;
        margin-bottom: 20px;
        line-height: 1.6;
      }

      .description a {
        color: rgba(37, 89, 139, 0.9);
        text-decoration: underline;
      }

      .description a:hover {
        color: white;
      }

      .recent-submissions {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-top: 20px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        overflow-x: auto;
      }

      .recent-submissions h2 {
        font-size: 1.5em;
        margin-bottom: 20px;
        color: #333;
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .control-chip {
        padding: 8px 16px;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        background: white;
        cursor: pointer;
        transition: all 0.3s;
        font-weight: 500;
        user-select: none;
        font-size: 0.9em;
    }

    .control-chip:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .control-chip.selected {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
    }

    .control-chip .record-count {
        background: rgba(255, 255, 255, 0.3);
        color: #333;
        margin-left: 6px;
        font-size: 0.85em;
    }

    .control-chip.selected .record-count {
        background: rgba(255, 255, 255, 0.9);
        color: #667eea;
    }

    @media (max-width: 768px) {
        .version-chip, .control-chip {
            padding: 6px 12px;
            font-size: 0.8em;
        }
    }

      @media (max-width: 768px) {
        h1 {
          font-size: 2em;
        }

        .controls {
          padding: 20px;
        }

        table {
          font-size: 0.75em;
          display: block;
          overflow-x: auto;
          white-space: nowrap;
        }

        th,
        td {
          padding: 8px 6px;
        }

        .ranking-table,
        .recent-submissions {
          padding: 15px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>Sky Air Race è¨˜éŒ²ã¾ã¨ã‚</h1>
        <div class="description">
          æœ¬ã‚µã‚¤ãƒˆã¯éå…¬å¼ã®è¨˜éŒ²ã¾ã¨ã‚ãƒšãƒ¼ã‚¸ã§ã™ã€‚<br />
          <a href="https://forms.gle/rojYVzxP28hz7vVr7" target="_blank"
            >ç”³è«‹ãƒšãƒ¼ã‚¸</a
          >ã‹ã‚‰æŠ•ç¨¿ã•ã‚ŒãŸè¨˜éŒ²ã‚’é›†è¨ˆãƒ»æ²è¼‰ã—ã¦ã„ã¾ã™ã€‚
        </div>
      </header>

      <div class="controls">
        <div class="control-group">
          <label for="category">å¤§ä¼šç¨®åˆ¥</label>
          <select id="category">
            <option value="">-- å¤§ä¼šç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
          </select>
        </div>

        <div class="control-group">
          <label for="course">ã‚³ãƒ¼ã‚¹</label>
          <select id="course" disabled>
            <option value="">-- ã¾ãšå¤§ä¼šç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>
          </select>
        </div>

        <div class="control-group">
            <label>æ“ä½œæ–¹æ³•</label>
            <div class="version-chips" id="controlChips">
                <!-- Dynamically populated -->
            </div>
        </div>

        <div class="control-group">
          <label>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</label>
          <div class="version-chips" id="versionChips">
            <!-- Dynamically populated -->
          </div>
        </div>

        <div class="control-group">
          <div class="checkbox-item">
            <input
              type="checkbox"
              id="approvedOnly"
              onchange="renderRanking()"
            />
            <label for="approvedOnly">æ‰¿èªæ¸ˆã®ã¿è¡¨ç¤º</label>
          </div>
        </div>
      </div>

      <div class="ranking-table" id="rankingTable">
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ®</div>
          <h2>å¤§ä¼šç¨®åˆ¥ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
          <p>ä¸Šè¨˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é¸ã‚“ã§ãã ã•ã„</p>
        </div>
      </div>

      <div class="recent-submissions">
        <h2>ğŸ“ æœ€è¿‘ã®ç”³è«‹</h2>
        <div id="recentSubmissionsTable">
          <div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        </div>
      </div>
    </div>

    <script>
      const DATA_JSON_URL = "./data.json?ts=${Date.now()}";

      let allData = [];
      let courseMaster = [];
      let versionMaster = [];
      let selectedVersions = [];
      let selectedControls = ['ã‚¿ãƒƒãƒ'];
      const CONTROL_TYPES = {
          'ã‚¿ãƒƒãƒ': 'ğŸ‘†',
          'ã‚¿ãƒƒãƒï¼ˆç®’ã‚ã‚Šï¼‰': 'ğŸ‘†(ğŸ§¹)',
          'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼': 'ğŸ®',
          'ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆç®’ã‚ã‚Šï¼‰': 'ğŸ®(ğŸ§¹)'
      };
      let currentSort = { column: "ã‚¿ã‚¤ãƒ ", order: "asc" };

      function formatDate(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}/${m}/${d}`;
      }

      function formatDateTime(dateString) {
        if (!dateString) return "-";
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hour = String(date.getHours()).padStart(2, "0");
        const minute = String(date.getMinutes()).padStart(2, "0");
        return `${year}/${month}/${day} ${hour}:${minute}`;
      }

      function toggleApprovalFilter() {
        document.getElementById("approvedOnly").checked =
          !document.getElementById("approvedOnly").checked;
        renderRanking();
      }

      function init() {
        setupEventListeners();
        loadData();
      }

      function populateCategories() {
        const categorySelect = document.getElementById("category");
        categorySelect.innerHTML =
          '<option value="">-- å¤§ä¼šç¨®åˆ¥ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';

        const categories = [
          ...new Set(courseMaster.map((item) => item["å¤§ä¼šç¨®åˆ¥"])),
        ];

        categories.forEach((cat) => {
          // ã“ã®å¤§ä¼šç¨®åˆ¥ã®è¨˜éŒ²æ•°ã‚’é›†è¨ˆ
          const count = allData.filter((row) => row["å¤§ä¼šç¨®åˆ¥"] === cat).length;

          const option = document.createElement("option");
          option.value = cat;
          option.textContent = `${cat} ï¼ˆ${count}ä»¶ï¼‰`;
          categorySelect.appendChild(option);
        });
      }

        function setupEventListeners() {
            document.getElementById('category').addEventListener('change', onCategoryChange);
            document.getElementById('course').addEventListener('change', () => {
                updateVersionCounts();
                updateControlCounts();
                renderRanking();
            });
        }

      function onCategoryChange() {
        const category = document.getElementById("category").value;
        const courseSelect = document.getElementById("course");

        courseSelect.innerHTML =
          '<option value="">-- ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„ --</option>';

        if (category) {
          courseSelect.disabled = false;
          const courses = courseMaster.filter(
            (item) => item["å¤§ä¼šç¨®åˆ¥"] === category,
          );
          courses.forEach((item) => {
            // ã“ã®ã‚³ãƒ¼ã‚¹ã®è¨˜éŒ²æ•°ã‚’é›†è¨ˆ
            const count = allData.filter(
              (row) =>
                row["å¤§ä¼šç¨®åˆ¥"] === category &&
                row["ã‚³ãƒ¼ã‚¹å"] === item["ã‚³ãƒ¼ã‚¹å"],
            ).length;

            const option = document.createElement("option");
            option.value = item["ã‚³ãƒ¼ã‚¹å"];
            option.textContent = `${item["ã‚³ãƒ¼ã‚¹å"]} ï¼ˆ${count}ä»¶ï¼‰`;
            courseSelect.appendChild(option);
          });
            updateVersionCounts();
            updateControlCounts();
        } else {
          courseSelect.disabled = true;
          updateVersionCounts();
          updateControlCounts();
          renderRanking();
        }
      }

      async function loadData() {
        const rankingTable = document.getElementById("rankingTable");
        rankingTable.innerHTML =
          '<div class="loading">ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>';

        try {
          const url = `./data.json?ts=${Date.now()}`;
          const response = await fetch(url, {cache: 'no-store'});
          if (!response.ok) {
            throw new Error("data.json ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ");
          }

          const json = await response.json();

          allData = json.records || [];
          courseMaster = json.courseMaster || [];
          versionMaster = json.versionMaster || [];

          console.log("records:", allData.length);
          console.log("courseMaster:", courseMaster);
          console.log("versionMaster:", versionMaster);

          populateCategories();
          populateVersionChips();
          populateControlChips();
          renderRanking();
          renderRecentSubmissions();
        } catch (error) {
          console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", error);
          rankingTable.innerHTML = `
                    <div class="empty-state">
                        <h2>ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</h2>
                        <p>${error.message}</p>
                    </div>
                `;
        }
      }

      function populateVersionChips() {
        const container = document.getElementById("versionChips");
        container.innerHTML = "";

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚¹ã‚¿ã®æœ€å¾Œã®è¡ŒãŒæœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³
        const versions = versionMaster
          .map((row) => row[Object.keys(row)[0]])
          .reverse();
        const latestVersion = versions[0];

        console.log("ãƒãƒ¼ã‚¸ãƒ§ãƒ³ä¸€è¦§ï¼ˆæ–°â†’å¤ï¼‰:", versions);
        console.log("æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³:", latestVersion);

        versions.forEach((version) => {
          // ã“ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã®è¨˜éŒ²æ•°ã‚’é›†è¨ˆ
          const count = allData.filter(
            (row) => row["ãƒãƒ¼ã‚¸ãƒ§ãƒ³"] === version,
          ).length;

          const chip = document.createElement("div");
          chip.className = "version-chip";
          chip.innerHTML = `${version}<span class="record-count">${count}</span>`;
          chip.dataset.version = version;

          // æœ€æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§é¸æŠ
          if (version === latestVersion) {
            chip.classList.add("selected");
            selectedVersions.push(version);
          }

          chip.addEventListener("click", () =>
            toggleVersionChip(chip, version),
          );
          container.appendChild(chip);
        });
      }

        function populateControlChips() {
            const container = document.getElementById('controlChips');
            container.innerHTML = '';
            
            Object.entries(CONTROL_TYPES).forEach(([controlType, icon]) => {
                const count = allData.filter(row => row['æ“ä½œæ–¹æ³•'] === controlType).length;
                
                const chip = document.createElement('div');
                chip.className = 'control-chip';
                chip.innerHTML = `${icon}<span class="record-count">${count}ä»¶</span>`;
                chip.dataset.control = controlType;
                
                // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ã€Œã‚¿ãƒƒãƒã€ã‚’é¸æŠ
                if (controlType === 'ã‚¿ãƒƒãƒ') {
                    chip.classList.add('selected');
                }
                
                chip.addEventListener('click', () => toggleControlChip(chip, controlType));
                container.appendChild(chip);
            });
        }

        function toggleControlChip(chip, controlType) {
            chip.classList.toggle('selected');
            
            if (selectedControls.includes(controlType)) {
                selectedControls = selectedControls.filter(c => c !== controlType);
            } else {
                selectedControls.push(controlType);
            }
            
            console.log('é¸æŠä¸­ã®æ“ä½œæ–¹æ³•:', selectedControls);
            renderRanking();
        }

        function updateControlCounts() {
            const category = document.getElementById('category').value;
            const course = document.getElementById('course').value;
            
            Object.keys(CONTROL_TYPES).forEach(controlType => {
                let count = allData.filter(r => r['æ“ä½œæ–¹æ³•'] === controlType);
                
                if (category) {
                    count = count.filter(r => r['å¤§ä¼šç¨®åˆ¥'] === category);
                }
                if (course) {
                    count = count.filter(r => r['ã‚³ãƒ¼ã‚¹å'] === course);
                }
                
                const countValue = count.length;
                
                const chip = document.querySelector(`.control-chip[data-control="${controlType}"]`);
                if (chip) {
                    const badge = chip.querySelector('.record-count');
                    if (badge) {
                        badge.textContent = `${countValue}ä»¶`;
                    }
                }
            });
        }

      function toggleVersionChip(chip, version) {
        chip.classList.toggle("selected");

        if (selectedVersions.includes(version)) {
          selectedVersions = selectedVersions.filter((v) => v !== version);
        } else {
          selectedVersions.push(version);
        }

        console.log("é¸æŠä¸­ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³:", selectedVersions);
        renderRanking();
      }

      function sortRanking(column) {
        // åŒã˜åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã€æ˜‡é †â†’é™é †â†’æ˜‡é †...ã¨åˆ‡ã‚Šæ›¿ãˆ
        if (currentSort.column === column) {
            currentSort.order = currentSort.order === "asc" ? "desc" : "asc";
        } else {
          // åˆ¥ã®åˆ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®é †åºã‚’è¨­å®š
            currentSort.column = column;
            if (column === "ãƒ¦ãƒ¼ã‚¶ãƒ¼å") {
            currentSort.order = "asc"; // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆæ˜‡é †
            } else if (column === "ã‚¿ã‚¤ãƒ ") {
            currentSort.order = "asc"; // æ˜‡é †ï¼ˆé€Ÿã„é †ï¼‰
            } else if (column === "è¨˜éŒ²æ—¥") {
              currentSort.order = "asc"; // æ˜‡é †ï¼ˆå¤ã„é †ï¼‰
            }
        }

        renderRanking();
        }

      function updateVersionCounts() {
        const category = document.getElementById('category').value;
        const course = document.getElementById('course').value;

        document.querySelectorAll('.version-chip').forEach(chip => {
            const version = chip.dataset.version;

            let count = allData.filter(r => r['ãƒãƒ¼ã‚¸ãƒ§ãƒ³'] === version);

            if (category) count = count.filter(r => r['å¤§ä¼šç¨®åˆ¥'] === category);
            if (course) count = count.filter(r => r['ã‚³ãƒ¼ã‚¹å'] === course);

            const badge = chip.querySelector('.record-count');
            if (badge) badge.textContent = `${count.length}ä»¶`;
        });
      }

      function renderRanking() {
        const category = document.getElementById("category").value;
        const course = document.getElementById("course").value;
        const approvedOnly = document.getElementById("approvedOnly").checked;
        const rankingTable = document.getElementById("rankingTable");

        if (!category || !course) {
          rankingTable.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ®</div>
                        <h2>å¤§ä¼šç¨®åˆ¥ã¨ã‚³ãƒ¼ã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„</h2>
                        <p>ä¸Šè¨˜ã®ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‹ã‚‰è¡¨ç¤ºã—ãŸã„ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’é¸ã‚“ã§ãã ã•ã„</p>
                    </div>
                `;
          return;
        }

        let filteredData = allData.filter(
          (row) => row["å¤§ä¼šç¨®åˆ¥"] === category && row["ã‚³ãƒ¼ã‚¹å"] === course,
        );

        console.log("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶:", { category, course });
        console.log("ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:", filteredData.length, "ä»¶");

        if (selectedVersions.length > 0) {
          filteredData = filteredData.filter((row) =>
            selectedVersions.includes(row["ãƒãƒ¼ã‚¸ãƒ§ãƒ³"]),
          );
          console.log("ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:", filteredData.length, "ä»¶");
        }
        if (selectedControls.length > 0) {
            filteredData = filteredData.filter(row => 
                selectedControls.includes(row['æ“ä½œæ–¹æ³•'])
            );
            console.log('æ“ä½œæ–¹æ³•ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:', filteredData.length, 'ä»¶');
        }

        if (approvedOnly) {
          filteredData = filteredData.filter((row) => row["æ‰¿èªçŠ¶æ…‹"] === "OK");
          console.log("æ‰¿èªãƒ•ã‚£ãƒ«ã‚¿ãƒ¼å¾Œ:", filteredData.length, "ä»¶");
        }

        filteredData.sort((a, b) => {
          let valueA, valueB;

          if (currentSort.column === "ã‚¿ã‚¤ãƒ ") {
            valueA = parseFloat(a["ã‚¿ã‚¤ãƒ "]);
            valueB = parseFloat(b["ã‚¿ã‚¤ãƒ "]);
          } else if (currentSort.column === "è¨˜éŒ²æ—¥") {
            valueA = new Date(a["è¨˜éŒ²æ—¥"]).getTime();
            valueB = new Date(b["è¨˜éŒ²æ—¥"]).getTime();
          } else if (currentSort.column === "ãƒ¦ãƒ¼ã‚¶ãƒ¼å") {
            valueA = (a["ãƒ¦ãƒ¼ã‚¶ãƒ¼å"] || "").toLowerCase();
            valueB = (b["ãƒ¦ãƒ¼ã‚¶ãƒ¼å"] || "").toLowerCase();
            return currentSort.order === "asc"
              ? valueA.localeCompare(valueB)
              : valueB.localeCompare(valueA);
          }

          return currentSort.order === "asc"
            ? valueA - valueB
            : valueB - valueA;
        });

        if (filteredData.length === 0) {
          rankingTable.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“­</div>
                        <h2>è©²å½“ã™ã‚‹ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“</h2>
                        <p>ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ã¿ã¦ãã ã•ã„</p>
                    </div>
                `;
          return;
        }

        let html = `
                <table>
                    <thead>
                        <tr>
                            <th class="sortable ${currentSort.column === "ãƒ¦ãƒ¼ã‚¶ãƒ¼å" ? "sort-" + currentSort.order : ""}" onclick="sortRanking('ãƒ¦ãƒ¼ã‚¶ãƒ¼å')">ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                            <th class="sortable ${currentSort.column === "ã‚¿ã‚¤ãƒ " ? "sort-" + currentSort.order : ""}" onclick="sortRanking('ã‚¿ã‚¤ãƒ ')">ã‚¿ã‚¤ãƒ </th>
                            <th class="sortable ${currentSort.column === "è¨˜éŒ²æ—¥" ? "sort-" + currentSort.order : ""}" onclick="sortRanking('è¨˜éŒ²æ—¥')">è¨˜éŒ²æ—¥</th>
                            <th>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th>
                            <th>å‹•ç”»</th>
                            <th>çŠ¶æ…‹</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        filteredData.forEach((row, index) => {
          const statusClass =
            row["æ‰¿èªçŠ¶æ…‹"] === "OK" ? "status-approved" : "status-pending";
          const statusText = row["æ‰¿èªçŠ¶æ…‹"] === "OK" ? "æ‰¿èªæ¸ˆ" : "æœªæ‰¿èª";

          // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼åã‹ã‚‰Xã®URLã‚’ç”Ÿæˆ
          const username = row["ãƒ¦ãƒ¼ã‚¶ãƒ¼å"] || "";
          const xHandle = username.startsWith("@")
            ? username.slice(1)
            : username;
          const playerDisplay = xHandle
            ? `<a href="https://x.com/${xHandle}" target="_blank" class="player-link">${username}</a>`
            : "-";

          html += `
                    <tr>
                        <td>${playerDisplay}</td>
                        <td><strong>${row["ã‚¿ã‚¤ãƒ "]}ç§’</strong></td>
                        <td>${formatDate(row["è¨˜éŒ²æ—¥"])}</td>
                        <td>${row["ãƒãƒ¼ã‚¸ãƒ§ãƒ³"] || "-"}</td>
                        <td>${row["ãƒªãƒ³ã‚¯"] ? `<a href="${row["ãƒªãƒ³ã‚¯"]}" target="_blank" class="video-link">â–¶</a>` : "-"}</td>
                        <td><span class="status-badge ${statusClass}">${statusText}</span></td>
                    </tr>
                `;
        });

        html += `
                    </tbody>
                </table>
            `;

        rankingTable.innerHTML = html;
      }

      function renderRecentSubmissions() {
        const container = document.getElementById("recentSubmissionsTable");

        if (allData.length === 0) {
          container.innerHTML =
            '<div class="empty-state"><p>ç”³è«‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</p></div>';
          return;
        }

        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ã§ã‚½ãƒ¼ãƒˆï¼ˆæ–°ã—ã„é †ï¼‰
        const sortedData = [...allData].sort((a, b) => {
          const dateA = new Date(a["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"]);
          const dateB = new Date(b["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"]);
          return dateB - dateA;
        });

        // æœ€æ–°5ä»¶ã‚’å–å¾—
        const recentData = sortedData.slice(0, 5);

        let html = `
                <table>
                    <thead>
                        <tr>
                            <th>ç”³è«‹æ—¥æ™‚</th>
                            <th>å¤§ä¼šç¨®åˆ¥</th>
                            <th>ã‚³ãƒ¼ã‚¹</th>
                            <th>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼</th>
                            <th>ã‚¿ã‚¤ãƒ </th>
                            <th>è¨˜éŒ²æ—¥</th>
                            <th>ãƒãƒ¼ã‚¸ãƒ§ãƒ³</th>
                            <th>å‹•ç”»</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

        recentData.forEach((row) => {
          const username = row["ãƒ¦ãƒ¼ã‚¶ãƒ¼å"] || "";
          const xHandle = username.startsWith("@")
            ? username.slice(1)
            : username;
          const playerDisplay = xHandle
            ? `<a href="https://x.com/${xHandle}" target="_blank" class="player-link">${username}</a>`
            : "-";

          html += `
                    <tr>
                        <td>${formatDateTime(row["ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—"])}</td>
                        <td>${row["å¤§ä¼šç¨®åˆ¥"] || "-"}</td>
                        <td>${row["ã‚³ãƒ¼ã‚¹å"] || "-"}</td>
                        <td>${playerDisplay}</td>
                        <td><strong>${row["ã‚¿ã‚¤ãƒ "]}ç§’</strong></td>
                        <td>${formatDate(row["è¨˜éŒ²æ—¥"])}</td>
                        <td>${row["ãƒãƒ¼ã‚¸ãƒ§ãƒ³"] || "-"}</td>
                        <td>${row["ãƒªãƒ³ã‚¯"] ? `<a href="${row["ãƒªãƒ³ã‚¯"]}" target="_blank" class="video-link">â–¶</a>` : "-"}</td>
                    </tr>
                `;
        });

        html += `
                    </tbody>
                </table>
            `;

        container.innerHTML = html;
      }

      init();
    </script>
    </div>

    <footer style="text-align: center; padding: 20px; color: rgba(37, 89, 139, 0.6); font-size: 0.85em;">
        æ”¹å–„ãƒ»è¦æœ›ã¯Remyiã®<a href="https://x.com/Re_myi_" target="_blank" style="color: rgba(37, 89, 139, 0.8); text-decoration: underline;"> X </a>ã¾ãŸã¯<a href="https://marshmallow-qa.com/re_myi_" target="_blank" style="color: rgba(37, 89, 139, 0.8); text-decoration: underline;">ãƒã‚·ãƒ¥ãƒãƒ­</a>ã¾ã§ã€‚
    </footer>
  </body>
</html>
